<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug RUC - Sistema Facturaci√≥n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .form-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .ruc-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .ruc-container input {
            flex: 1;
        }
        button {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success { 
            color: green; 
            padding: 10px; 
            background: #f0f8f0; 
            border: 1px solid #d4edda;
            border-radius: 4px; 
            margin-top: 10px;
        }
        .error { 
            color: red; 
            padding: 10px; 
            background: #f8f0f0; 
            border: 1px solid #f5c6cb;
            border-radius: 4px; 
            margin-top: 10px;
        }
        .warning { 
            color: orange; 
            padding: 10px; 
            background: #f8f8f0; 
            border: 1px solid #ffeaa7;
            border-radius: 4px; 
            margin-top: 10px;
        }
        .field-status {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug RUC - Sistema Facturaci√≥n Electr√≥nica</h1>
    
    <div class="debug-panel" id="debug-log">
        <strong>üêõ DEBUG LOG:</strong><br>
        P√°gina cargada - esperando interacciones...<br>
    </div>
    
    <div class="two-column">
        <!-- Panel de prueba -->
        <div class="form-container">
            <h2>üß™ Prueba de RUC</h2>
            
            <div class="form-group">
                <label>RUC/DNI:</label>
                <div class="ruc-container">
                    <input type="text" id="numeroDocumento" placeholder="20100047218" maxlength="11">
                    <button type="button" onclick="consultarRuc()" id="btnConsultarRuc">
                        üîç Consultar RUC
                    </button>
                </div>
                <small>Prueba con: 20100047218 (BCP), 20100017491 (Telef√≥nica), 20100053455 (Interbank)</small>
            </div>
            
            <div id="mensaje-cliente"></div>
        </div>
        
        <!-- Panel de campos -->
        <div class="form-container">
            <h2>üìã Campos del Cliente</h2>
            
            <div class="form-group">
                <label>Tipo Documento:</label>
                <select id="tipoDocumento">
                    <option value="06">RUC</option>
                    <option value="01">DNI</option>
                </select>
                <div class="field-status" id="status-tipoDocumento">Sin datos</div>
            </div>
            
            <div class="form-group">
                <label>Raz√≥n Social:</label>
                <input type="text" id="razonSocial" placeholder="Empresa Demo SAC">
                <div class="field-status" id="status-razonSocial">Sin datos</div>
            </div>
            
            <div class="form-group">
                <label>Nombre Comercial:</label>
                <input type="text" id="nombreComercial" placeholder="Demo">
                <div class="field-status" id="status-nombreComercial">Sin datos</div>
            </div>
            
            <div class="form-group">
                <label>Direcci√≥n:</label>
                <input type="text" id="direccion" placeholder="Av. Demo 123">
                <div class="field-status" id="status-direccion">Sin datos</div>
            </div>
            
            <div class="form-group">
                <label>Departamento:</label>
                <input type="text" id="departamento" placeholder="LIMA">
                <div class="field-status" id="status-departamento">Sin datos</div>
            </div>
            
            <div class="form-group">
                <label>Provincia:</label>
                <input type="text" id="provincia" placeholder="LIMA">
                <div class="field-status" id="status-provincia">Sin datos</div>
            </div>
            
            <div class="form-group">
                <label>Distrito:</label>
                <input type="text" id="distrito" placeholder="MIRAFLORES">
                <div class="field-status" id="status-distrito">Sin datos</div>
            </div>
            
            <div class="form-group">
                <label>Ubigeo:</label>
                <input type="text" id="ubigeo" placeholder="150101">
                <div class="field-status" id="status-ubigeo">Sin datos</div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api';
        
        function debugLog(mensaje) {
            const debugPanel = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            debugPanel.innerHTML += `<br>[${timestamp}] ${mensaje}`;
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[DEBUG] ${mensaje}`);
        }
        
        function updateFieldStatus(fieldId, mensaje) {
            const statusElement = document.getElementById(`status-${fieldId}`);
            if (statusElement) {
                statusElement.textContent = mensaje;
                debugLog(`Estado campo ${fieldId}: ${mensaje}`);
            }
        }
        
        function mostrarMensaje(elementId, mensaje, tipo) {
            debugLog(`Mostrando mensaje (${tipo}): ${mensaje}`);
            const elemento = document.getElementById(elementId);
            if (elemento) {
                const claseCSS = tipo === 'success' ? 'success' : tipo === 'warning' ? 'warning' : 'error';
                elemento.innerHTML = `<div class="${claseCSS}">${mensaje}</div>`;
                
                // Auto-limpiar mensaje despu√©s de 5 segundos
                setTimeout(() => {
                    elemento.innerHTML = '';
                    debugLog('Mensaje auto-limpiado');
                }, 5000);
            } else {
                debugLog(`ERROR: Elemento ${elementId} no encontrado`);
            }
        }
        
        async function consultarRuc() {
            debugLog('=== INICIO CONSULTA RUC ===');
            
            const ruc = document.getElementById('numeroDocumento').value.trim();
            const btnConsultar = document.getElementById('btnConsultarRuc');
            
            debugLog(`RUC ingresado: "${ruc}"`);
            debugLog(`Bot√≥n encontrado: ${btnConsultar ? 'S√ç' : 'NO'}`);
            
            // Validar RUC
            if (!ruc || ruc.length !== 11 || !/^\d{11}$/.test(ruc)) {
                debugLog('ERROR: RUC inv√°lido');
                mostrarMensaje('mensaje-cliente', 'Por favor ingrese un RUC v√°lido de 11 d√≠gitos', 'error');
                return;
            }
            
            debugLog('RUC v√°lido - iniciando consulta');
            
            // Cambiar estado del bot√≥n
            if (btnConsultar) {
                btnConsultar.disabled = true;
                btnConsultar.innerHTML = '‚è≥ Consultando...';
                debugLog('Bot√≥n deshabilitado');
            }
            
            try {
                const url = `${API_BASE}/consulta-ruc/${ruc}`;
                debugLog(`URL de consulta: ${url}`);
                
                const response = await fetch(url);
                debugLog(`Respuesta HTTP: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const result = await response.json();
                    debugLog(`Datos recibidos: ${JSON.stringify(result, null, 2)}`);
                    
                    if (result.success && result.data) {
                        debugLog('=== INICIANDO AUTOCOMPLETADO ===');
                        const data = result.data;
                        
                        // Autocompletar campos con validaci√≥n
                        const campos = [
                            { id: 'tipoDocumento', valor: '06', label: 'Tipo Documento' },
                            { id: 'razonSocial', valor: data.razonSocial || '', label: 'Raz√≥n Social' },
                            { id: 'nombreComercial', valor: data.nombreComercial || data.razonSocial || '', label: 'Nombre Comercial' },
                            { id: 'direccion', valor: data.direccion || '', label: 'Direcci√≥n' },
                            { id: 'departamento', valor: data.departamento || '', label: 'Departamento' },
                            { id: 'provincia', valor: data.provincia || '', label: 'Provincia' },
                            { id: 'distrito', valor: data.distrito || '', label: 'Distrito' },
                            { id: 'ubigeo', valor: data.ubigeo || '', label: 'Ubigeo' }
                        ];
                        
                        campos.forEach(campo => {
                            const elemento = document.getElementById(campo.id);
                            if (elemento) {
                                elemento.value = campo.valor;
                                updateFieldStatus(campo.id, `Autocompletado: "${campo.valor}"`);
                                debugLog(`‚úÖ ${campo.label}: "${campo.valor}"`);
                            } else {
                                debugLog(`‚ùå ERROR: Campo ${campo.id} no encontrado`);
                            }
                        });
                        
                        debugLog('=== AUTOCOMPLETADO FINALIZADO ===');
                        
                        mostrarMensaje('mensaje-cliente', 
                            `‚úÖ Datos encontrados en SUNAT: ${data.razonSocial} - Estado: ${data.estado}`, 
                            'success');
                    } else {
                        debugLog('No se encontraron datos o consulta no exitosa');
                        mostrarMensaje('mensaje-cliente', 
                            `‚ö†Ô∏è ${result.message || 'RUC no encontrado en SUNAT'}`, 
                            'warning');
                    }
                } else {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                debugLog(`ERROR en consulta: ${error.message}`);
                console.error('Error consultando RUC:', error);
                mostrarMensaje('mensaje-cliente', 
                    `‚ùå Error al consultar RUC: ${error.message}`, 
                    'error');
            } finally {
                // Restaurar estado del bot√≥n
                if (btnConsultar) {
                    btnConsultar.disabled = false;
                    btnConsultar.innerHTML = 'üîç Consultar RUC';
                    debugLog('Bot√≥n restaurado');
                }
                debugLog('=== FIN CONSULTA RUC ===');
            }
        }
        
        // Validaci√≥n en tiempo real del RUC
        function initRucValidation() {
            debugLog('Inicializando validaci√≥n de RUC');
            const rucInput = document.getElementById('numeroDocumento');
            const btnConsultar = document.getElementById('btnConsultarRuc');
            
            if (rucInput && btnConsultar) {
                rucInput.addEventListener('input', function() {
                    const ruc = this.value.trim();
                    const esValido = ruc.length === 11 && /^\d{11}$/.test(ruc);
                    
                    btnConsultar.disabled = !esValido;
                    btnConsultar.style.opacity = esValido ? '1' : '0.6';
                    
                    debugLog(`RUC: "${ruc}" - V√°lido: ${esValido}`);
                    
                    if (ruc.length > 0 && !esValido) {
                        mostrarMensaje('mensaje-cliente', 
                            '‚ö†Ô∏è El RUC debe tener exactamente 11 d√≠gitos', 
                            'warning');
                    }
                });
                debugLog('Validaci√≥n de RUC configurada');
            } else {
                debugLog('ERROR: No se encontraron elementos para validaci√≥n');
            }
        }
        
        // Ejecutar inicializaci√≥n cuando cargue la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('üöÄ DOM Content Loaded - Inicializando sistema');
            initRucValidation();
            debugLog('‚úÖ Sistema iniciado correctamente');
            
            // Agregar listeners para detectar cambios en campos
            const campos = ['tipoDocumento', 'razonSocial', 'nombreComercial', 'direccion', 'departamento', 'provincia', 'distrito', 'ubigeo'];
            campos.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) {
                    elemento.addEventListener('change', function() {
                        updateFieldStatus(campo, `Valor actual: "${this.value}"`);
                    });
                }
            });
        });
        
        debugLog('üìÑ Script cargado - esperando DOM Content Loaded');
    </script>
</body>
</html>